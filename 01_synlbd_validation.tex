\documentclass{article}
\usepackage{statrep}
\usepackage{parskip,xspace}
\usepackage{attachfile}
\newcommand*{\Statrep}{\mbox{\textsf{StatRep}}\xspace}
\newcommand*{\Code}[1]{\texttt{\textbf{#1}}}
\newcommand*{\cs}[1]{\texttt{\textbf{\textbackslash#1}}}
\setcounter{secnumdepth}{0}
\title{Example and Tutorial for SynLBD Validation}
\author{Lars Vilhuber, Jorgen Harris, and Emin Dinlersoz}
\date{\today}
\begin{document}
\maketitle
\section{Introduction}
We want to provide an example of proper validation criteria, using a fake dataset as our input.


\begin{quotation}
This article uses the \Statrep \LaTeX\ package.
The package is available
for download at \texttt{http://support.sas.com/StatRepPackage}. To generate this document, 
\begin{verbatim}
pdflatex file.tex
sas file_SR.sas
pdflatex file.tex
pdflatex file.tex
\end{verbatim}
or see Appendix~\ref{sec:statrep}.
\end{quotation}


\section{The Fake Dataset}
We create a dataset that approximates, very roughly, the characteristics of the establishment and employment distribution of a real dataset such as the SynLBD and LBD. We use this so that the document is maximally portable, given distribution restrictions for both SynLBD and LBD.

\begin{Datastep}[program]
options nocenter;
libname home ".";

/* basic parameters */
%let indcnt=40;
%let maxestabcnt=10000;
%let minestabcnt=100;
%let seed1=123456;

%let maxemp=42000;
%let minemp=1;
%let seed2=1234567;
\end{Datastep}

\begin{Datastep}
/* draw estab count distribution across industries*/
/* use log normal */
data industries;
  do industry = 1 to &indcnt.;
  estabs= exp(ranuni(&seed1.)*
                (log(&maxestabcnt.)
                -log(&minestabcnt.)) 
                + log(&minestabcnt.));
  output;
  end;
  run;


/* now draw employment for each estab in each industry */

data fakelbd;
  set industries;
  by industry;
  drop i;
  do lbdnum=100000*industry+1 to 100000*industry+estabs; 
    do year=1 to 3;
       emp= exp(ranuni(&seed2.)
         *(log(&maxemp.)-log(&minemp.)) 
         + log(&minemp.));
    payroll  = emp*30*ranuni(3153);
    output;
  end; end;
run;
\end{Datastep}

We can assess the distributions, first of establishments:

\begin{Sascode}[store=univarA,program]
ods graphics on;
  proc univariate data=industries;
  var estabs;
  run;
  ods graphics off;
 \end{Sascode}
\Listing[store=univarA,caption={Statistics on establishments},objects=BasicMeasures ]{univarA}

Let's have a look at the distribution of employment:

\begin{Sascode}[store=univarB,program]
ods graphics on;
proc univariate data=fakelbd;
var emp;
run;
ods graphics off;
\end{Sascode}
\Listing[store=univarB,caption={Statistics on employment},objects=BasicMeasures]{univarB}

The number of establishments across industries varies, which will lead to difficulties if we want to obtain results for certain industries:

\begin{Sascode}[store=obsperind,program]
proc freq data=fakelbd;
table industry;
run;
\end{Sascode}
\Listing[store=obsperind,caption={Number of obs per industry}]{obsperind}

\section{Project 1:  Analysis that meets validation requirements}
This example is a project where the analysis, and the validation request, meet the requirements. This project is interested in ... First, the researcher prepares the data:

\begin{Datastep}
/*Prepare data*/
/* program: 01_prepdata.sas */
data analysis1;
set fakelbd;
by industry lbdnum year;
wage = payroll/emp;
if first.lbdnum then do; 
	lagE = .;         
	lagp = .;         
	lagw = .;         
end;
else                 do; 
	lagE = lag(emp); 
	lagp=lag(payroll); 
	lagw = lag(wage); 
end;
empgrowth = emp/lage;
wagegrowth= wage/lagw;
run;
\end{Datastep}

Then, the regression of interest to the researcher is run:

\begin{Sascode}[store=regA]
/*Regression of interest*/
proc reg data=analysis1;
by industry;
where industry le 2;
model empgrowth = lagE lagw;
output out=obsds1 r=inc;
ods output parameterestimates=param1;
run;
ods trace off;
\end{Sascode}
The result of the regression is the following output (here for the first industry only):

\Listing[store=regA,objects=Reg.ByGroup1.MODEL1.Fit.empgrowth.ParameterEstimates,caption={Project 1: Parameter estimates}]{regAparms}

In order to prepare for validation and disclosure avoidance review of the \textit{confidential} analysis, the researcher must determine  the effective sample size of each parameter in terms of establishments and total observations. Ideally, this is provided as an ``augmented'' results table that allows the Census Bureau disclosure officer to assess the whole picture. The following code will generate that information:
\begin{Datastep}
proc sql;
create table discreview1 as
select industry,count(distinct lbdnum) as nEstabs,count(*) as nObs
from obsds1
where inc ne .
group by industry
;quit;
data discreview1;
  merge discreview1(in=_a)
               param1(in=_b);
   by industry;
 run;
\end{Datastep}

Finally, in order to prepare the validation request, as well as the release request for the synthetic data results, \textit{both} tables are written out as CSV files:
\begin{Datastep}
/*Export validation table and sample size table*/
proc export data=param1 file="./validationtable1.csv" dbms=csv replace;
run;
\end{Datastep}
\begin{Sascode}[store=paramAcsv,program]
proc print data=param1;
run;
\end{Sascode}
\Listing[store=paramAcsv,label=tab:paramA]{paramAcsv}

\begin{Datastep}
proc export data=discreview1 file="./discreview1.csv" dbms=csv replace;
run;
\end{Datastep}
\begin{Sascode}[store=discreviewA,program]
proc print data=discreview1;
run;
\end{Sascode}
\Listing[store=discreviewA,label=tab:discA]{discreviewA}

In fact, if using \LaTeX, the researcher could attach all programs and output from the synthetic data to the validation request, and submit it:

\begin{itemize}
\item 01\_synlbd\_validation\_SR.sas \attachfile{01_synlbd_validation_SR.sas}
\item validationtable1.csv \attachfile{validationtable1.csv}
\item discreview1.csv \attachfile{discreview1.csv}
\end{itemize}

Note that the result tables as shown here would be based on the synthetic data, and both \Code{discreview1.csv} and \Code{validationtable1.csv} would be released to the researcher. However, the results validated against the confidential data would differ from those reported in Figure~\ref{tab:paramA}, and the  \Code{discreview1.csv} file generated from the confidential data, using the code submitted by the researcher, would NOT be released.





\newpage

\appendix
\input{99_appendix_statrep}

\end{document}
